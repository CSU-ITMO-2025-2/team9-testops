name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images and charts'
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-cd-pipeline
  cancel-in-progress: false

jobs:
  # ============================================================================
  # STAGE 1: DETECT CHANGES
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      django_changed: ${{ steps.changes.outputs.django }}
      consumer_changed: ${{ steps.changes.outputs.consumer }}
      notification_changed: ${{ steps.changes.outputs.notification }}
      helm_infra_changed: ${{ steps.changes.outputs.helm_infra }}
      helm_publisher_changed: ${{ steps.changes.outputs.helm_publisher }}
      helm_consumer_changed: ${{ steps.changes.outputs.helm_consumer }}
      helm_notification_changed: ${{ steps.changes.outputs.helm_notification }}
      helm_postdeploy_changed: ${{ steps.changes.outputs.helm_postdeploy }}
      argocd_changed: ${{ steps.changes.outputs.argocd }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
      
    - name: Generate version tag
      id: version
      run: |
        VERSION=${GITHUB_SHA::7}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: Check for changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          django:
            - 'canvas/**'
            - 'api_tests/**'
            - 'home/**'
            - 'templates/**'
            - 'static/**'
            - 'Dockerfile'
            - 'requirements.txt'
            - 'manage.py'
          consumer:
            - 'test-execute-consumer/**'
            - 'watch.py'
            - 'requirements.txt'
          notification:
            - 'notification-service/**'
          helm_infra:
            - 'helm/testops-infra/**'
          helm_publisher:
            - 'helm/testops-publisher/**'
          helm_consumer:
            - 'helm/testops-consumer/**'
          helm_notification:
            - 'helm/testops-notification/**'
          helm_postdeploy:
            - 'helm/testops-postdeploy/**'
          argocd:
            - 'argocd/**'

  # ============================================================================
  # STAGE 2: BUILD IMAGES (PARALLEL)
  # ============================================================================
  build-django:
    name: Build Django Image
    needs: detect-changes
    if: needs.detect-changes.outputs.django_changed == 'true' || github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Django app image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:${{ needs.detect-changes.outputs.version }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops:buildcache,mode=max

  build-consumer:
    name: Build Consumer Image
    needs: detect-changes
    if: needs.detect-changes.outputs.consumer_changed == 'true' || github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Consumer image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./test-execute-consumer/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:${{ needs.detect-changes.outputs.version }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:buildcache,mode=max

  build-notification:
    name: Build Notification Image
    needs: detect-changes
    if: needs.detect-changes.outputs.notification_changed == 'true' || github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Notification service image
      uses: docker/build-push-action@v4
      with:
        context: ./notification-service
        file: ./notification-service/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:${{ needs.detect-changes.outputs.version }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:buildcache,mode=max

  # ============================================================================
  # STAGE 3: UPDATE HELM CHARTS (SEQUENTIAL - TR√ÅNH CONFLICT)
  # ============================================================================
  
  # Nh√°nh 1: Infra Chart
  update-chart-infra:
    name: Update Infra Chart
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.helm_infra_changed == 'true' || 
      needs.detect-changes.outputs.argocd_changed == 'true' ||
      github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-infra/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-infra/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-infra: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-infra/Chart.yaml 2>/dev/null || true
        git add helm/testops-infra/Chart.lock 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore(infra): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]"
        fi
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 2: Publisher Chart
  update-chart-publisher:
    name: Update Publisher Chart
    needs: [detect-changes, build-django, update-chart-infra]
    if: |
      always() &&
      (needs.detect-changes.outputs.django_changed == 'true' || 
       needs.detect-changes.outputs.helm_publisher_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-publisher/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-publisher/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${{ needs.detect-changes.outputs.version }}\"/" helm/testops-publisher/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-publisher: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Update image tag in values.yaml
      if: needs.detect-changes.outputs.django_changed == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "Updating Django app image tag to ${{ needs.detect-changes.outputs.version }}"
        sed -i "/djangoApp:/,/service:/ s|tag:.*|tag: \"${{ needs.detect-changes.outputs.version }}\"|" helm/testops-publisher/values.yaml
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-publisher/Chart.yaml 2>/dev/null || true
        git add helm/testops-publisher/values.yaml 2>/dev/null || true
        git add helm/testops-publisher/Chart.lock 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore(publisher): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]"
        fi
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 3: Consumer Chart
  update-chart-consumer:
    name: Update Consumer Chart
    needs: [detect-changes, build-consumer, update-chart-publisher]
    if: |
      always() &&
      (needs.detect-changes.outputs.consumer_changed == 'true' || 
       needs.detect-changes.outputs.helm_consumer_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-consumer/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-consumer/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${{ needs.detect-changes.outputs.version }}\"/" helm/testops-consumer/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-consumer: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Update image tag in values.yaml
      if: needs.detect-changes.outputs.consumer_changed == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "Updating Consumer image tag to ${{ needs.detect-changes.outputs.version }}"
        sed -i "/consumer:/,/service:/ s|tag:.*|tag: \"${{ needs.detect-changes.outputs.version }}\"|" helm/testops-consumer/values.yaml
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-consumer/Chart.yaml 2>/dev/null || true
        git add helm/testops-consumer/values.yaml 2>/dev/null || true
        git add helm/testops-consumer/Chart.lock 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore(consumer): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]"
        fi
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 4: Notification Chart
  update-chart-notification:
    name: Update Notification Chart
    needs: [detect-changes, build-notification, update-chart-consumer]
    if: |
      always() &&
      (needs.detect-changes.outputs.notification_changed == 'true' || 
       needs.detect-changes.outputs.helm_notification_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-notification/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-notification/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${{ needs.detect-changes.outputs.version }}\"/" helm/testops-notification/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-notification: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Update image tag in values.yaml
      if: needs.detect-changes.outputs.notification_changed == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "Updating Notification service image tag to ${{ needs.detect-changes.outputs.version }}"
        sed -i "/image:/,/service:/ s|tag:.*|tag: \"${{ needs.detect-changes.outputs.version }}\"|" helm/testops-notification/values.yaml
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-notification/Chart.yaml 2>/dev/null || true
        git add helm/testops-notification/values.yaml 2>/dev/null || true
        git add helm/testops-notification/Chart.lock 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore(notification): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]"
        fi
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 5: Postdeploy Chart
  update-chart-postdeploy:
    name: Update Postdeploy Chart
    needs: [detect-changes, update-chart-notification]
    if: |
      always() &&
      (needs.detect-changes.outputs.helm_postdeploy_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-postdeploy/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-postdeploy/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-postdeploy: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-postdeploy/Chart.yaml 2>/dev/null || true
        git add helm/testops-postdeploy/Chart.lock 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore(postdeploy): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]"
        fi
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # ============================================================================
  # STAGE 4: PACKAGE AND PUBLISH HELM CHARTS TO GH-PAGES
  # ============================================================================
  package-and-publish-charts:
    name: Package & Publish Charts
    needs:
      - detect-changes
      - update-chart-infra
      - update-chart-publisher
      - update-chart-consumer
      - update-chart-notification
      - update-chart-postdeploy
    if: |
      always() &&
      (needs.update-chart-infra.result == 'success' ||
       needs.update-chart-publisher.result == 'success' ||
       needs.update-chart-consumer.result == 'success' ||
       needs.update-chart-notification.result == 'success' ||
       needs.update-chart-postdeploy.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'
    
    - name: Checkout gh-pages branch
      run: |
        git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
        git checkout gh-pages
        
        # Create charts directory if not exists
        mkdir -p charts
    
    - name: Package Helm charts
      run: |
        # Checkout main to get latest chart files
        git checkout main -- helm/
        
        # Package each chart
        if [ "${{ needs.update-chart-infra.result }}" == "success" ]; then
          echo "üì¶ Packaging testops-infra..."
          helm package helm/testops-infra -d charts/
        fi
        
        if [ "${{ needs.update-chart-publisher.result }}" == "success" ]; then
          echo "üì¶ Packaging testops-publisher..."
          helm package helm/testops-publisher -d charts/
        fi
        
        if [ "${{ needs.update-chart-consumer.result }}" == "success" ]; then
          echo "üì¶ Packaging testops-consumer..."
          helm package helm/testops-consumer -d charts/
        fi
        
        if [ "${{ needs.update-chart-notification.result }}" == "success" ]; then
          echo "üì¶ Packaging testops-notification..."
          helm package helm/testops-notification -d charts/
        fi
        
        if [ "${{ needs.update-chart-postdeploy.result }}" == "success" ]; then
          echo "üì¶ Packaging testops-postdeploy..."
          helm package helm/testops-postdeploy -d charts/
        fi
    
    - name: Generate index
      run: |
        # Generate/update index.yaml
        # helm repo index will automatically merge with existing index.yaml if it exists
        if [ -f charts/index.yaml ]; then
          echo "üìã Merging with existing index.yaml..."
          helm repo index charts/ --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts --merge charts/index.yaml
        else
          echo "üìã Creating new index.yaml..."
          helm repo index charts/ --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts
        fi
        echo "‚úÖ Index updated successfully"
    
    - name: Generate index.html
      run: |
        # Create index.html that dynamically reads index.yaml
        REPO_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        cat > index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>TestOps Helm Charts</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
            .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
            h2 { color: #555; margin-top: 30px; margin-bottom: 15px; }
            .repo-info { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0; }
            code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; }
            .chart-section { margin: 20px 0; }
            .versions { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
            .version-badge { display: inline-block; background: #007bff; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; }
            .version-badge.old { background: #6c757d; }
            #loading { text-align: center; color: #666; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>üì¶ TestOps Helm Repository</h1>
            <div class="repo-info">
              <p><strong>Repository URL:</strong> <code>${REPO_URL}</code></p>
              <p><strong>Last Updated:</strong> <span id="timestamp">-</span></p>
            </div>
            <div id="content">
              <div id="loading">‚è≥ Loading chart versions...</div>
            </div>
          </div>
          <script>
            fetch('charts/index.yaml')
              .then(response => response.text())
              .then(data => {
                const timestamp = new Date().toLocaleString();
                document.getElementById('timestamp').textContent = timestamp;
                
                // Parse YAML format - helm chart-releaser format
                const lines = data.split('\n');
                const charts = {};
                let currentChart = null;

                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  // Match chart name like "  testops-infra:" or "  ai-testops:"
                  if (line.match(/^  [a-zA-Z0-9-]+:$/) && !line.includes('entries')) {
                    currentChart = line.replace(':', '').trim();
                    charts[currentChart] = [];
                  } 
                  // Match version line like "    version: 1.2.0"
                  else if (currentChart && line.match(/^\s+version:\s/)) {
                    const version = line.split(':')[1].trim().replace(/"/g, '');
                    charts[currentChart].push(version);
                  }
                }

                const compareSemverDesc = (a, b) => {
                  const pa = a.split('.').map(Number);
                  const pb = b.split('.').map(Number);
                  const len = Math.max(pa.length, pb.length);
                  for (let i = 0; i < len; i++) {
                    const da = pa[i] || 0;
                    const db = pb[i] || 0;
                    if (da !== db) return db - da;
                  }
                  return 0;
                };

                // Generate HTML
                const content = document.getElementById('content');
                content.innerHTML = '';
                
                for (const [chart, versions] of Object.entries(charts)) {
                  if (versions.length === 0) continue;
                  
                  const uniq = Array.from(new Set(versions));
                  const top10 = uniq.sort(compareSemverDesc).slice(0, 10);
                  
                  const section = document.createElement('div');
                  section.className = 'chart-section';
                  
                  let html = '<h2>' + chart + '</h2><div class="versions">';
                  top10.forEach((v, idx) => {
                    const badgeClass = idx === 0 ? 'version-badge' : 'version-badge old';
                    html += '<span class="' + badgeClass + '">' + v + '</span>';
                  });
                  html += '</div>';
                  
                  section.innerHTML = html;
                  content.appendChild(section);
                }
              })
              .catch(error => {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = '<p style="color: red;">‚ùå Error loading chart versions</p>';
              });
          </script>
        </body>
        </html>
        EOF
        echo "‚úÖ index.html generated successfully"
    
    - name: Commit and push to gh-pages
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        git add charts/ index.html
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: publish helm charts [skip ci]"
          git push origin gh-pages
          echo "‚úÖ Charts and index.html published to gh-pages"
        fi

  # ============================================================================
  # STAGE 5: CREATE ALL GIT TAGS
  # ============================================================================
  create-all-tags:
    name: Create All Git Tags
    needs: 
      - detect-changes
      - update-chart-infra
      - update-chart-publisher
      - update-chart-consumer
      - update-chart-notification
      - update-chart-postdeploy
      - package-and-publish-charts
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.update-chart-infra.result == 'success' ||
       needs.update-chart-publisher.result == 'success' ||
       needs.update-chart-consumer.result == 'success' ||
       needs.update-chart-notification.result == 'success' ||
       needs.update-chart-postdeploy.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Pull latest changes
      run: |
        git pull origin main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create all tags
      run: |
        # Function to create tag if it doesn't exist
        create_tag_if_not_exists() {
          local tag_name=$1
          local tag_message=$2
          
          if git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "‚è≠Ô∏è  Tag $tag_name already exists"
          else
            git tag -a "$tag_name" -m "$tag_message"
            echo "‚úÖ Created tag: $tag_name"
          fi
        }
        
        # Main release tag
        RELEASE_TAG="testops-${{ needs.detect-changes.outputs.version }}"
        create_tag_if_not_exists "$RELEASE_TAG" "Release ${{ needs.detect-changes.outputs.version }}"
        
        # Infra chart tag
        if [ "${{ needs.update-chart-infra.result }}" == "success" ]; then
          INFRA_TAG="testops-infra-${{ needs.update-chart-infra.outputs.chart_version }}"
          create_tag_if_not_exists "$INFRA_TAG" "Release testops-infra ${{ needs.update-chart-infra.outputs.chart_version }}"
        fi
        
        # Publisher chart tag
        if [ "${{ needs.update-chart-publisher.result }}" == "success" ]; then
          PUBLISHER_TAG="testops-publisher-${{ needs.update-chart-publisher.outputs.chart_version }}"
          create_tag_if_not_exists "$PUBLISHER_TAG" "Release testops-publisher ${{ needs.update-chart-publisher.outputs.chart_version }}"
        fi
        
        # Consumer chart tag
        if [ "${{ needs.update-chart-consumer.result }}" == "success" ]; then
          CONSUMER_TAG="testops-consumer-${{ needs.update-chart-consumer.outputs.chart_version }}"
          create_tag_if_not_exists "$CONSUMER_TAG" "Release testops-consumer ${{ needs.update-chart-consumer.outputs.chart_version }}"
        fi
        
        # Notification chart tag
        if [ "${{ needs.update-chart-notification.result }}" == "success" ]; then
          NOTIFICATION_TAG="testops-notification-${{ needs.update-chart-notification.outputs.chart_version }}"
          create_tag_if_not_exists "$NOTIFICATION_TAG" "Release testops-notification ${{ needs.update-chart-notification.outputs.chart_version }}"
        fi
        
        # Postdeploy chart tag
        if [ "${{ needs.update-chart-postdeploy.result }}" == "success" ]; then
          POSTDEPLOY_TAG="testops-postdeploy-${{ needs.update-chart-postdeploy.outputs.chart_version }}"
          create_tag_if_not_exists "$POSTDEPLOY_TAG" "Release testops-postdeploy ${{ needs.update-chart-postdeploy.outputs.chart_version }}"
        fi
    
    - name: Push all tags at once
      run: |
        echo "Pushing all tags to remote..."
        git push origin --tags
        echo "‚úÖ All tags pushed successfully"

  # ============================================================================
  # STAGE 6: DEPLOYMENT SUMMARY
  # ============================================================================
  deployment-summary:
    name: Deployment Summary
    needs: 
      - detect-changes
      - build-django
      - build-consumer
      - build-notification
      - update-chart-infra
      - update-chart-publisher
      - update-chart-consumer
      - update-chart-notification
      - update-chart-postdeploy
      - package-and-publish-charts
      - create-all-tags
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate deployment summary
      run: |
        echo "# üöÄ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üì¶ Version Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Version:** \`${{ needs.detect-changes.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Git Commit:** \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Helm Repository:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üî® Build Status" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Django
        if [ "${{ needs.build-django.result }}" == "success" ]; then
          echo "| Django Image | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-django.result }}" == "failure" ]; then
          echo "| Django Image | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Django Image | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Consumer
        if [ "${{ needs.build-consumer.result }}" == "success" ]; then
          echo "| Consumer Image | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-consumer.result }}" == "failure" ]; then
          echo "| Consumer Image | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Consumer Image | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Notification
        if [ "${{ needs.build-notification.result }}" == "success" ]; then
          echo "| Notification Image | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.build-notification.result }}" == "failure" ]; then
          echo "| Notification Image | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Notification Image | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üìä Helm Chart Updates" >> $GITHUB_STEP_SUMMARY
        echo "| Chart | Version | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Infra
        if [ "${{ needs.update-chart-infra.result }}" == "success" ]; then
          echo "| Infra | \`${{ needs.update-chart-infra.outputs.chart_version }}\` | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.update-chart-infra.result }}" == "failure" ]; then
          echo "| Infra | - | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Infra | unchanged | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Publisher
        if [ "${{ needs.update-chart-publisher.result }}" == "success" ]; then
          echo "| Publisher | \`${{ needs.update-chart-publisher.outputs.chart_version }}\` | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.update-chart-publisher.result }}" == "failure" ]; then
          echo "| Publisher | - | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Publisher | unchanged | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Consumer
        if [ "${{ needs.update-chart-consumer.result }}" == "success" ]; then
          echo "| Consumer | \`${{ needs.update-chart-consumer.outputs.chart_version }}\` | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.update-chart-consumer.result }}" == "failure" ]; then
          echo "| Consumer | - | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Consumer | unchanged | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Notification
        if [ "${{ needs.update-chart-notification.result }}" == "success" ]; then
          echo "| Notification | \`${{ needs.update-chart-notification.outputs.chart_version }}\` | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.update-chart-notification.result }}" == "failure" ]; then
          echo "| Notification | - | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Notification | unchanged | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Postdeploy
        if [ "${{ needs.update-chart-postdeploy.result }}" == "success" ]; then
          echo "| Postdeploy | \`${{ needs.update-chart-postdeploy.outputs.chart_version }}\` | ‚úÖ success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.update-chart-postdeploy.result }}" == "failure" ]; then
          echo "| Postdeploy | - | ‚ùå failure |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Postdeploy | unchanged | ‚è≠Ô∏è skipped |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üì¶ Helm Repository" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.package-and-publish-charts.result }}" == "success" ]; then
          echo "- **Status:** ‚úÖ Charts published successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Add Repository:**" >> $GITHUB_STEP_SUMMARY
          echo '  ```bash' >> $GITHUB_STEP_SUMMARY
          echo "  helm repo add testops https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts" >> $GITHUB_STEP_SUMMARY
          echo "  helm repo update" >> $GITHUB_STEP_SUMMARY
          echo '  ```' >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.package-and-publish-charts.result }}" == "failure" ]; then
          echo "- **Status:** ‚ùå Chart publishing failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** ‚è≠Ô∏è No charts to publish" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üè∑Ô∏è Git Tags" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.create-all-tags.result }}" == "success" ]; then
          echo "- **Status:** ‚úÖ All tags created successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.create-all-tags.result }}" == "failure" ]; then
          echo "- **Status:** ‚ùå Tag creation failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** ‚è≠Ô∏è Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for any failures
        if [ "${{ needs.build-django.result }}" == "failure" ] || \
           [ "${{ needs.build-consumer.result }}" == "failure" ] || \
           [ "${{ needs.build-notification.result }}" == "failure" ] || \
           [ "${{ needs.update-chart-infra.result }}" == "failure" ] || \
           [ "${{ needs.update-chart-publisher.result }}" == "failure" ] || \
           [ "${{ needs.update-chart-consumer.result }}" == "failure" ] || \
           [ "${{ needs.update-chart-notification.result }}" == "failure" ] || \
           [ "${{ needs.update-chart-postdeploy.result }}" == "failure" ] || \
           [ "${{ needs.package-and-publish-charts.result }}" == "failure" ] || \
           [ "${{ needs.create-all-tags.result }}" == "failure" ]; then
          echo "## ‚ö†Ô∏è Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the failed jobs above for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚úÖ Pipeline Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "All jobs completed without errors." >> $GITHUB_STEP_SUMMARY
        fi