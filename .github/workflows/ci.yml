name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images and charts'
        required: false
        default: false
        type: boolean

concurrency:
  group: ci-cd-pipeline
  cancel-in-progress: false

jobs:
  # ============================================================================
  # STAGE 1: DETECT CHANGES
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      django_changed: ${{ steps.changes.outputs.django }}
      consumer_changed: ${{ steps.changes.outputs.consumer }}
      notification_changed: ${{ steps.changes.outputs.notification }}
      helm_infra_changed: ${{ steps.changes.outputs.helm_infra }}
      helm_publisher_changed: ${{ steps.changes.outputs.helm_publisher }}
      helm_consumer_changed: ${{ steps.changes.outputs.helm_consumer }}
      helm_notification_changed: ${{ steps.changes.outputs.helm_notification }}
      helm_postdeploy_changed: ${{ steps.changes.outputs.helm_postdeploy }}
      argocd_changed: ${{ steps.changes.outputs.argocd }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
      
    - name: Generate version tag
      id: version
      run: |
        VERSION=${GITHUB_SHA::7}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: Check for changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          django:
            - 'canvas/**'
            - 'api_tests/**'
            - 'home/**'
            - 'templates/**'
            - 'static/**'
            - 'Dockerfile'
            - 'requirements.txt'
            - 'manage.py'
          consumer:
            - 'test-execute-consumer/**'
            - 'watch.py'
            - 'requirements.txt'
          notification:
            - 'notification-service/**'
          helm_infra:
            - 'helm/testops-infra/**'
          helm_publisher:
            - 'helm/testops-publisher/**'
          helm_consumer:
            - 'helm/testops-consumer/**'
          helm_notification:
            - 'helm/testops-notification/**'
          helm_postdeploy:
            - 'helm/testops-postdeploy/**'
          argocd:
            - 'argocd/**'

  # ============================================================================
  # STAGE 2: BUILD IMAGES (PARALLEL)
  # ============================================================================
  build-django:
    name: Build Django Image
    needs: detect-changes
    if: needs.detect-changes.outputs.django_changed == 'true' || github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Django app image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:${{ needs.detect-changes.outputs.version }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops:buildcache,mode=max

  build-consumer:
    name: Build Consumer Image
    needs: detect-changes
    if: needs.detect-changes.outputs.consumer_changed == 'true' || github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Consumer image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./test-execute-consumer/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:${{ needs.detect-changes.outputs.version }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:buildcache,mode=max

  build-notification:
    name: Build Notification Image
    needs: detect-changes
    if: needs.detect-changes.outputs.notification_changed == 'true' || github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push Notification service image
      uses: docker/build-push-action@v4
      with:
        context: ./notification-service
        file: ./notification-service/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:${{ needs.detect-changes.outputs.version }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:latest
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ai-testops-notification:buildcache,mode=max

  # ============================================================================
  # STAGE 3: UPDATE HELM CHARTS (PARALLEL - M·ªñI CHART M·ªòT NH√ÅNH)
  # ============================================================================
  
  # Nh√°nh 1: Infra Chart
  update-chart-infra:
    name: Update Infra Chart
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.helm_infra_changed == 'true' || 
      needs.detect-changes.outputs.argocd_changed == 'true' ||
      github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-infra/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-infra/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-infra: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-infra/Chart.yaml helm/testops-infra/Chart.lock
        git commit -m "chore(infra): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]" || echo "No changes to commit"
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 2: Publisher Chart
  update-chart-publisher:
    name: Update Publisher Chart
    needs: [detect-changes, build-django]
    if: |
      always() &&
      (needs.detect-changes.outputs.django_changed == 'true' || 
       needs.detect-changes.outputs.helm_publisher_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-publisher/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-publisher/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${{ needs.detect-changes.outputs.version }}\"/" helm/testops-publisher/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-publisher: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Update image tag in values.yaml
      if: needs.detect-changes.outputs.django_changed == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "Updating Django app image tag to ${{ needs.detect-changes.outputs.version }}"
        sed -i "/djangoApp:/,/service:/ s|tag:.*|tag: \"${{ needs.detect-changes.outputs.version }}\"|" helm/testops-publisher/values.yaml
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-publisher/Chart.yaml helm/testops-publisher/values.yaml helm/testops-publisher/Chart.lock
        git commit -m "chore(publisher): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]" || echo "No changes to commit"
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 3: Consumer Chart
  update-chart-consumer:
    name: Update Consumer Chart
    needs: [detect-changes, build-consumer]
    if: |
      always() &&
      (needs.detect-changes.outputs.consumer_changed == 'true' || 
       needs.detect-changes.outputs.helm_consumer_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-consumer/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-consumer/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${{ needs.detect-changes.outputs.version }}\"/" helm/testops-consumer/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-consumer: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Update image tag in values.yaml
      if: needs.detect-changes.outputs.consumer_changed == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "Updating Consumer image tag to ${{ needs.detect-changes.outputs.version }}"
        sed -i "/consumer:/,/service:/ s|tag:.*|tag: \"${{ needs.detect-changes.outputs.version }}\"|" helm/testops-consumer/values.yaml
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-consumer/Chart.yaml helm/testops-consumer/values.yaml helm/testops-consumer/Chart.lock
        git commit -m "chore(consumer): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]" || echo "No changes to commit"
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 4: Notification Chart
  update-chart-notification:
    name: Update Notification Chart
    needs: [detect-changes, build-notification]
    if: |
      always() &&
      (needs.detect-changes.outputs.notification_changed == 'true' || 
       needs.detect-changes.outputs.helm_notification_changed == 'true' ||
       needs.detect-changes.outputs.argocd_changed == 'true' ||
       github.event.inputs.force_rebuild == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-notification/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-notification/Chart.yaml
        sed -i "s/^appVersion:.*/appVersion: \"${{ needs.detect-changes.outputs.version }}\"/" helm/testops-notification/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-notification: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Update image tag in values.yaml
      if: needs.detect-changes.outputs.notification_changed == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "Updating Notification service image tag to ${{ needs.detect-changes.outputs.version }}"
        sed -i "/image:/,/service:/ s|tag:.*|tag: \"${{ needs.detect-changes.outputs.version }}\"|" helm/testops-notification/values.yaml
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-notification/Chart.yaml helm/testops-notification/values.yaml helm/testops-notification/Chart.lock
        git commit -m "chore(notification): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]" || echo "No changes to commit"
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # Nh√°nh 5: Postdeploy Chart
  update-chart-postdeploy:
    name: Update Postdeploy Chart
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.helm_postdeploy_changed == 'true' ||
      needs.detect-changes.outputs.argocd_changed == 'true' ||
      github.event.inputs.force_rebuild == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      chart_version: ${{ steps.bump.outputs.CHART_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
    
    - name: Bump chart version
      id: bump
      run: |
        CURRENT_VERSION=$(grep '^version:' helm/testops-postdeploy/Chart.yaml | awk '{print $2}')
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_PATCH=$((patch + 1))
        CHART_VERSION="${major}.${minor}.${NEW_PATCH}"
        
        sed -i "s/^version:.*/version: $CHART_VERSION/" helm/testops-postdeploy/Chart.yaml
        
        echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped testops-postdeploy: $CURRENT_VERSION -> $CHART_VERSION"
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Commit changes
      run: |
        git add helm/testops-postdeploy/Chart.yaml helm/testops-postdeploy/Chart.lock
        git commit -m "chore(postdeploy): bump chart to ${{ steps.bump.outputs.CHART_VERSION }} [skip ci]" || echo "No changes to commit"
    
    - name: Push changes
      run: |
        git pull --rebase origin main
        git push origin HEAD:main

  # ============================================================================
  # STAGE 4: CREATE GIT TAGS (PARALLEL - M·ªñI CHART M·ªòT NH√ÅNH)
  # ============================================================================
  
  # Nh√°nh Tag 1: Main Release Tag
  create-tag-release:
    name: Create Release Tag
    needs: [detect-changes]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create release tag
      run: |
        TAG_NAME="testops-${{ needs.detect-changes.outputs.version }}"
        if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -a "$TAG_NAME" -m "Release ${{ needs.detect-changes.outputs.version }}"
          git push origin "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
        else
          echo "Tag $TAG_NAME already exists"
        fi

  # Nh√°nh Tag 2: Infra Chart Tag
  create-tag-infra:
    name: Create Infra Chart Tag
    needs: [update-chart-infra]
    if: |
      always() &&
      needs.update-chart-infra.result == 'success' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create chart tag
      run: |
        TAG_NAME="testops-infra-${{ needs.update-chart-infra.outputs.chart_version }}"
        if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -a "$TAG_NAME" -m "Release testops-infra ${{ needs.update-chart-infra.outputs.chart_version }}"
          git push origin "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
        else
          echo "Tag $TAG_NAME already exists"
        fi

  # Nh√°nh Tag 3: Publisher Chart Tag
  create-tag-publisher:
    name: Create Publisher Chart Tag
    needs: [update-chart-publisher]
    if: |
      always() &&
      needs.update-chart-publisher.result == 'success' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create chart tag
      run: |
        TAG_NAME="testops-publisher-${{ needs.update-chart-publisher.outputs.chart_version }}"
        if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -a "$TAG_NAME" -m "Release testops-publisher ${{ needs.update-chart-publisher.outputs.chart_version }}"
          git push origin "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
        else
          echo "Tag $TAG_NAME already exists"
        fi

  # Nh√°nh Tag 4: Consumer Chart Tag
  create-tag-consumer:
    name: Create Consumer Chart Tag
    needs: [update-chart-consumer]
    if: |
      always() &&
      needs.update-chart-consumer.result == 'success' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create chart tag
      run: |
        TAG_NAME="testops-consumer-${{ needs.update-chart-consumer.outputs.chart_version }}"
        if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -a "$TAG_NAME" -m "Release testops-consumer ${{ needs.update-chart-consumer.outputs.chart_version }}"
          git push origin "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
        else
          echo "Tag $TAG_NAME already exists"
        fi

  # Nh√°nh Tag 5: Notification Chart Tag
  create-tag-notification:
    name: Create Notification Chart Tag
    needs: [update-chart-notification]
    if: |
      always() &&
      needs.update-chart-notification.result == 'success' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create chart tag
      run: |
        TAG_NAME="testops-notification-${{ needs.update-chart-notification.outputs.chart_version }}"
        if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -a "$TAG_NAME" -m "Release testops-notification ${{ needs.update-chart-notification.outputs.chart_version }}"
          git push origin "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
        else
          echo "Tag $TAG_NAME already exists"
        fi

  # Nh√°nh Tag 6: Postdeploy Chart Tag
  create-tag-postdeploy:
    name: Create Postdeploy Chart Tag
    needs: [update-chart-postdeploy]
    if: |
      always() &&
      needs.update-chart-postdeploy.result == 'success' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
        ref: main
    
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Create chart tag
      run: |
        TAG_NAME="testops-postdeploy-${{ needs.update-chart-postdeploy.outputs.chart_version }}"
        if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          git tag -a "$TAG_NAME" -m "Release testops-postdeploy ${{ needs.update-chart-postdeploy.outputs.chart_version }}"
          git push origin "$TAG_NAME"
          echo "Created tag: $TAG_NAME"
        else
          echo "Tag $TAG_NAME already exists"
        fi

  # ============================================================================
  # STAGE 5: DEPLOYMENT SUMMARY
  # ============================================================================
  deployment-summary:
    name: Deployment Summary
    needs: 
      - detect-changes
      - build-django
      - build-consumer
      - build-notification
      - update-chart-infra
      - update-chart-publisher
      - update-chart-consumer
      - update-chart-notification
      - update-chart-postdeploy
      - create-tag-release
      - create-tag-infra
      - create-tag-publisher
      - create-tag-consumer
      - create-tag-notification
      - create-tag-postdeploy
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate deployment summary
      run: |
        echo "# üöÄ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üì¶ Version Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Version:** \`${{ needs.detect-changes.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üî® Build Status" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Django Image | ${{ needs.build-django.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Consumer Image | ${{ needs.build-consumer.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Notification Image | ${{ needs.build-notification.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üìä Helm Chart Updates" >> $GITHUB_STEP_SUMMARY
        echo "| Chart | Version | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Infra | \`${{ needs.update-chart-infra.outputs.chart_version || 'unchanged' }}\` | ${{ needs.update-chart-infra.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Publisher | \`${{ needs.update-chart-publisher.outputs.chart_version || 'unchanged' }}\` | ${{ needs.update-chart-publisher.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Consumer | \`${{ needs.update-chart-consumer.outputs.chart_version || 'unchanged' }}\` | ${{ needs.update-chart-consumer.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Notification | \`${{ needs.update-chart-notification.outputs.chart_version || 'unchanged' }}\` | ${{ needs.update-chart-notification.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Postdeploy | \`${{ needs.update-chart-postdeploy.outputs.chart_version || 'unchanged' }}\` | ${{ needs.update-chart-postdeploy.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üè∑Ô∏è Git Tags" >> $GITHUB_STEP_SUMMARY
        echo "| Tag Type | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Release | ${{ needs.create-tag-release.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Infra Chart | ${{ needs.create-tag-infra.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Publisher Chart | ${{ needs.create-tag-publisher.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Consumer Chart | ${{ needs.create-tag-consumer.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Notification Chart | ${{ needs.create-tag-notification.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Postdeploy Chart | ${{ needs.create-tag-postdeploy.result || '‚è≠Ô∏è skipped' }} |" >> $GITHUB_STEP_SUMMARY