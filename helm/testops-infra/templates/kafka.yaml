{{- if .Values.global.strimzi.kafka.enabled }}
---
# KafkaNodePool for Broker nodes
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: {{ .Values.global.strimzi.kafka.name }}-broker
  namespace: {{ .Values.global.namespace }}
  labels:
    strimzi.io/cluster: {{ .Values.global.strimzi.kafka.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  replicas: {{ .Values.global.strimzi.kafka.brokers.replicas }}
  roles:
    - broker
  storage:
    type: {{ .Values.global.strimzi.kafka.storage.type }}
    {{- if eq .Values.global.strimzi.kafka.storage.type "persistent-claim" }}
    size: {{ .Values.global.strimzi.kafka.storage.size | default "10Gi" }}
    {{- end }}
  resources:
    requests:
      memory: {{ .Values.global.strimzi.kafka.brokers.resources.requests.memory }}
      cpu: {{ .Values.global.strimzi.kafka.brokers.resources.requests.cpu }}
    limits:
      memory: {{ .Values.global.strimzi.kafka.brokers.resources.limits.memory }}
      cpu: {{ .Values.global.strimzi.kafka.brokers.resources.limits.cpu }}
  template:
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: strimzi.io/name
                    operator: In
                    values:
                      - {{ .Values.global.strimzi.kafka.name }}-kafka
              topologyKey: kubernetes.io/hostname

---
# KafkaNodePool for Controller nodes (KRaft)
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: {{ .Values.global.strimzi.kafka.name }}-controller
  namespace: {{ .Values.global.namespace }}
  labels:
    strimzi.io/cluster: {{ .Values.global.strimzi.kafka.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  replicas: {{ .Values.global.strimzi.kafka.controller.replicas | default 1 }}
  roles:
    - controller
  storage:
    type: {{ .Values.global.strimzi.kafka.storage.type }}
    {{- if eq .Values.global.strimzi.kafka.storage.type "persistent-claim" }}
    size: {{ .Values.global.strimzi.kafka.storage.controllerSize | default "5Gi" }}
    {{- end }}
  resources:
    requests:
      memory: {{ .Values.global.strimzi.kafka.controller.resources.requests.memory | default "256Mi" }}
      cpu: {{ .Values.global.strimzi.kafka.controller.resources.requests.cpu | default "100m" }}
    limits:
      memory: {{ .Values.global.strimzi.kafka.controller.resources.limits.memory | default "512Mi" }}
      cpu: {{ .Values.global.strimzi.kafka.controller.resources.limits.cpu | default "200m" }}
  template:
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: strimzi.io/name
                    operator: In
                    values:
                      - {{ .Values.global.strimzi.kafka.name }}-kafka
              topologyKey: kubernetes.io/hostname

---
# Main Kafka cluster (KRaft mode - no ZooKeeper)
apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: {{ .Values.global.strimzi.kafka.name }}
  namespace: {{ .Values.global.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  kafka:
    version: {{ .Values.global.strimzi.kafka.version | default "4.1.1" }}
    metadataVersion: {{ .Values.global.strimzi.kafka.metadataVersion | default "4.1-IV1" }}
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: scram-sha-512
    config:
      offsets.topic.replication.factor: {{ .Values.global.strimzi.kafka.brokers.replicas }}
      transaction.state.log.replication.factor: {{ .Values.global.strimzi.kafka.brokers.replicas }}
      transaction.state.log.min.isr: {{ .Values.global.strimzi.kafka.minInSyncReplicas | default 1 }}
      default.replication.factor: {{ .Values.global.strimzi.kafka.brokers.replicas }}
      min.insync.replicas: {{ .Values.global.strimzi.kafka.minInSyncReplicas | default 1 }}
    resources:
      requests:
        memory: {{ .Values.global.strimzi.kafka.brokers.resources.requests.memory }}
        cpu: {{ .Values.global.strimzi.kafka.brokers.resources.requests.cpu }}
      limits:
        memory: {{ .Values.global.strimzi.kafka.brokers.resources.limits.memory }}
        cpu: {{ .Values.global.strimzi.kafka.brokers.resources.limits.cpu }}
  entityOperator:
    topicOperator:
      resources:
        limits:
          cpu: {{ .Values.global.strimzi.kafka.topicOperator.resources.limits.cpu }}
          memory: {{ .Values.global.strimzi.kafka.topicOperator.resources.limits.memory }}
        requests:
          cpu: {{ .Values.global.strimzi.kafka.topicOperator.resources.requests.cpu }}
          memory: {{ .Values.global.strimzi.kafka.topicOperator.resources.requests.memory }}
    userOperator:
      resources:
        limits:
          cpu: {{ .Values.global.strimzi.kafka.userOperator.resources.limits.cpu }}
          memory: {{ .Values.global.strimzi.kafka.userOperator.resources.limits.memory }}
        requests:
          cpu: {{ .Values.global.strimzi.kafka.userOperator.resources.requests.cpu }}
          memory: {{ .Values.global.strimzi.kafka.userOperator.resources.requests.memory }}
{{- end }}
